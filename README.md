# LinkedDocMemory
Personal knowledge graph and memory retrieval system for AI agents, featuring BM25 search and LLM-powered association engine. （AIエージェント向けのパーソナル・ナレッジグラフおよび記憶検索システム。BM25検索とLLMによる連想エンジンを搭載。）
# ローカルAI 長期記憶システム (LinkedDocMemory)

## 1. コアコンセプト
人間の脳の「連想記憶」や「活性化拡散モデル（Spreading Activation Model）」を模倣し、ObsidianのMarkdownファイル群をナレッジグラフとして活用するローカルAI向けの長期記憶システムです。
パーソナライズされたPageRank（PPR）アルゴリズムに類似した仕組みを、特定のアプリに依存しない独自のプレーンテキストベースのデータ構造で実現します。

## 2. 3つの基盤構造と実装知見

### ① 強度付きデータリンク構造 (ナレッジグラフ基盤)
* **リンクの非対称性とメタデータ保存:** 連想の非対称性（A→Bへの連想強度とB→Aへの連想強度は異なる）を許容し、各Markdownファイルの「YAMLフロントマター」には、**自分から相手への外向き（Outbound）のリンク強度のみ**を保持するルールとします。これによりファイル競合を防ぎつつ巨大な有向グラフをインメモリに構築可能です。
* **正規化:** 1つの文書から出るリンク強度の総和は常に 1.0 になるように算出・管理します。
* **実装知見:** YAMLフロントマターの保守性を確保するため、Python標準の `yaml` ではなく、フォーマットやコメントを維持できる `ruamel.yaml` が非常に有用に働きます。

### ② 高速検索機構 (昼間・リアルタイム用)
ユーザーの作業を妨げず、即座に関連文脈をAIエージェントに提供する軽量プロセス（Tool/Skill）です。
* **実装知見 (コールドスタートの克服):** 初期状態の検索（発火点）を「ベクトル検索」ではなく「BM25（キーワード検索）」で行うことで、まだドキュメント同士のリンクがない新規ファイルであっても、検索キーワードが含まれていれば確実に見つけ出す事（コールドスタートの回避）ができました。
* **減衰付き伝播 (Spreading Activation):** BM25で得た初期スコアを起点とし、リンク強度（重み）×「減衰率」をネットワーク上で伝播させることで、「ベクトル（文脈）だけでは拾えないが、ナレッジグラフ上では強く関連しているノート」を有機的に抽出できます。

### ③ 想起・連想・忘却機構 (夜間・バッチ処理用)
人間の睡眠時の「記憶の固定化（Memory Consolidation）」を模倣した、深い意味的推論を行うプロセスです。
* **新情報の統合 (連想):** リンクを持たない孤立したメモ等をスキャンし、LLM機能（Gemini APIやローカルLLM等）を利用して既存メモとの関連性を評価させます。閾値を超えた場合、自動的に新規リンク（シナプス）の追記とYAMLウェイトの形成が行われます。
* **実装の汎用化:** `LLM_BASE_URL` などを環境変数から切り替え可能にすることで、推論エンジンを問わない構造が実現可能です。

## 3. このリポジトリのソースコード構成

システムは主に以下のPythonスクリプトファイル群で構成されています。

### コアモジュール
* **`retriever_core.py`**
  指定フォルダ内のMarkdownファイルを走査し、本文のWikilink（`[[リンク]]`）パース、YAMLフロントマターのリンク強度読み込みを行って NetworkX の有向グラフと BM25 検索インデックスをインメモリに構築・管理するコアルーチン。
* **`llm_association.py`**
  `.env` ファイルから設定（APIキーやURL）を読み込み、OpenAI互換のLLMクライアントを初期化して、2つのテキスト間の関連性スコアを評価する推論モジュール。

### インターフェース・バッチ実行ファイル
* **`memory_tool.py`**
  AIエージェントなどからTool/Skillとして呼び出すためのエントリーポイント。`retrieve_context(keyword, max_length)` のようなシンプルな関数を提供し、リアルタイムでのコンテキスト抽出を担います。
* **`batch_processor.py`**
  真夜中やアイドル時に実行されることを想定した「想・連想・忘却」を行うバッチエンジンです。
  孤立ドキュメントの探索、LLMを通じた新規リンクの形成と自動追記、無駄なリンクの忘却（削除）、および重み合計の正規化（1.0に再計算）を行います。

### デモ・テスト用スクリプト
* **`test_retriever.py`**
  `memory_tool.py` を呼び出し、「直接ヒット」と「連想先抽出」、および文字数切り捨て処理が正常に走ることを確認するテスト。
* **`SampleDocs/` ディレクトリ**
  テスト用の著作権フリーなダミーMarkdownデータ群。バッチ処理による書き換えの実験などに使用します。

## 4. 環境構築と使い方
1. Python環境を作成後、依存ライブラリをインストールします。
   `pip install -r requirements.txt`
2. `.env.example` をコピーして `.env` を作成し、ドキュメントの場所 (`DOCS_DIR`) と LLMのAPIキー/URLを設定します。
3. `python test_retriever.py` で昼間のコンテキスト抽出をテストできます。
4. `python batch_processor.py` で自動での関連付け・連想形成バッチを実行できます。
